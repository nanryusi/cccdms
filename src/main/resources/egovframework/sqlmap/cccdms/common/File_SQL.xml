<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="File">

	<typeAlias  alias="FileVO" type="egovframework.cccdms.common.model.FileVO"/>

 	<select id="FileManageDAO.selectFileList" parameterClass="FileVO" resultClass="FileVO" >
 		<![CDATA[
			SELECT 
				a.ATCH_FILE_ID, b.FILE_CN, b.FILE_SN, b.FILE_STRE_COURS, b.STRE_FILE_NM,
				b.FILE_EXTSN, b.ORIGNL_FILE_NM, b.FILE_SIZE, a.REG_DT
			FROM
				TB_ATCH_FILE a, TB_ATCH_FILE_DETAIL b
			WHERE
				a.ATCH_FILE_ID = #atchFileId#
			AND 
				a.ATCH_FILE_ID = b.ATCH_FILE_ID
			AND 
				a.DEL_YN = 'Y'				
			ORDER BY b.FILE_SN	
 		]]>
 	</select>
 	
	<insert id="FileManageDAO.insertFileMaster" parameterClass="FileVO" >
		<![CDATA[
			INSERT INTO TB_ATCH_FILE
			(ATCH_FILE_ID, REG_DT, DEL_YN)
			VALUES
			( #atchFileId#, NOW(), 'Y')			
		]]>
	</insert>
	
	<insert id="FileManageDAO.insertFileDetail" parameterClass="FileVO" >
		<![CDATA[
			INSERT INTO TB_ATCH_FILE_DETAIL
			( ATCH_FILE_ID, FILE_SN, FILE_STRE_COURS, STRE_FILE_NM, 
			  ORIGNL_FILE_NM, FILE_EXTSN, FILE_SIZE, FILE_CN )
			VALUES
			( #atchFileId#, #fileSn#, #fileStreCours#, #streFileNm#, 
			  #orignlFileNm#, #fileExtsn#, #fileMg#, #fileCn# )			
		]]>
	</insert>	
	
	<delete id="FileManageDAO.deleteFileDetail" parameterClass="FileVO" >
		<![CDATA[
			DELETE FROM TB_ATCH_FILE_DETAIL
			WHERE
				ATCH_FILE_ID = #atchFileId#
			AND	
				FILE_SN = #fileSn#			
		]]>	
	</delete>
 	
	<select id="FileManageDAO.getMaxFileSN" parameterClass="FileVO" resultClass="java.lang.Integer">
		<![CDATA[
			SELECT COALESCE(MAX(FILE_SN),0)+1 AS FILE_SN
			FROM TB_ATCH_FILE_DETAIL
			WHERE ATCH_FILE_ID =  #atchFileId#		
		]]>
	</select>

 	<select id="FileManageDAO.selectFileInf" parameterClass="FileVO" resultClass="FileVO" >
 		<![CDATA[
			SELECT 
				ATCH_FILE_ID, FILE_CN, FILE_SN, FILE_STRE_COURS, STRE_FILE_NM,
				FILE_EXTSN, ORIGNL_FILE_NM, FILE_SIZE
			FROM
				TB_ATCH_FILE_DETAIL
			WHERE
				ATCH_FILE_ID = #atchFileId#
			AND 
				FILE_SN = #fileSn#	
 		]]>
 	</select>

	<update id="FileManageDAO.deleteCOMTNFILE" parameterClass="FileVO" >
		<![CDATA[
			UPDATE TB_ATCH_FILE
			SET DEL_YN = 'N'
			WHERE ATCH_FILE_ID = #atchFileId#
		]]>
	</update>

 	<select id="FileManageDAO.selectFileListByFileNm" parameterClass="FileVO" resultClass="FileVO" >
 		<![CDATA[
			SELECT 
				a.ATCH_FILE_ID, b.FILE_CN, b.FILE_SN, b.FILE_STRE_COURS, b.STRE_FILE_NM,
				b.FILE_EXTSN, b.ORIGNL_FILE_NM, b.FILE_SIZE, a.REG_DT
			FROM
				TB_ATCH_FILE a, TB_ATCH_FILE_DETAIL b
			WHERE
				a.ATCH_FILE_ID = b.ATCH_FILE_ID
			AND 
				a.DEL_YN = 'Y'
 		]]>
			<isEqual prepend="AND" property="searchCnd" compareValue="streFileNm">
				<![CDATA[	b.STRE_FILE_NM LIKE '%' || #searchWrd# || '%' 		]]>
			</isEqual>
			<isEqual prepend="AND" property="searchCnd" compareValue="orignlFileNm">
				<![CDATA[	b.ORIGNL_FILE_NM LIKE '%' || #searchWrd# || '%' 		]]>
			</isEqual>	
		<![CDATA[			
			ORDER BY a.ATCH_FILE_ID, b.FILE_SN	
			LIMIT #recordCountPerPage# OFFSET #firstIndex#
		]]>		 		
 	</select>

 	<select id="FileManageDAO.selectFileListCntByFileNm" parameterClass="FileVO" resultClass="java.lang.Integer" >
 		<![CDATA[
			SELECT 
				COUNT(a.ATCH_FILE_ID)
			FROM
				TB_ATCH_FILE a, TB_ATCH_FILE_DETAIL b
			WHERE
				a.ATCH_FILE_ID = b.ATCH_FILE_ID
			AND 
				a.DEL_YN = 'Y'				
 		]]>
			<isEqual prepend="AND" property="searchCnd" compareValue="streFileNm">
				<![CDATA[	b.STRE_FILE_NM LIKE '%' || #searchWrd# || '%' 		]]>
			</isEqual>
			<isEqual prepend="AND" property="searchCnd" compareValue="orignlFileNm">
				<![CDATA[	b.ORIGNL_FILE_NM LIKE '%' || #searchWrd# '%'  		]]>
			</isEqual>	 		
 	</select>
 	
  	<select id="FileManageDAO.selectImageFileList" parameterClass="FileVO" resultClass="FileVO" >
 		<![CDATA[
			SELECT 
				a.ATCH_FILE_ID, b.FILE_CN, b.FILE_SN, b.FILE_STRE_COURS, b.STRE_FILE_NM,
				b.FILE_EXTSN, b.ORIGNL_FILE_NM, b.FILE_SIZE, a.REG_DT
			FROM
				TB_ATCH_FILE a, TB_ATCH_FILE_DETAIL b
			WHERE
				a.ATCH_FILE_ID = #atchFileId#
			AND 
				a.ATCH_FILE_ID = b.ATCH_FILE_ID
			AND
				UPPER(b.FILE_EXTSN) IN ('GIF','JPG','BMP','PNG')
			AND 
				a.DEL_YN = 'Y'				
			ORDER BY b.FILE_SN	
 		]]>
 	</select>	
 	
</sqlMap>
